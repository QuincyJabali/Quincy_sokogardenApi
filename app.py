from flask import *
import pymysql 
import os


app=Flask(__name__)
app.config["UPLOAD_FOLDER"]= "static/images"

# sign up api -> create an account
@app.route("/api/signup", methods=["POST"])
def signUp():
    username= request.form["username"]
    email= request.form["email"]
    phone= request.form["phone"]
    password= request.form["password"]

    print(username,email,phone,password)
    # create a connection to the database
    connection = pymysql.connect(host="localhost", user="root", password="", database="quincy_sokogarden")

    # create a cursor
    cursor = connection.cursor()
    # create sql query
    sql= "insert into users(username,email,phone,password) values(%s,%s,%s,%s)"
    # data to be saved
    data= (username,email,phone,password)
    print(data)

    # execute the query
    cursor.execute(sql,data)
    # save the data in the db
    connection.commit()    

    return jsonify({"message" :"user signup successfully"})

@app.route("/api/signin", methods=["POST"])
def signin():
    email = request.form ["email"]
    password = request.form ["password"]
    print(email,password)

    connection = pymysql.connect(host="localhost",user="root",password="",database="quincy_sokogarden")

    cursor= connection.cursor(pymysql.cursors.DictCursor)

    sql= "select user_id,username,email,phone from users where email=%s and password=%s"
    data=(email,password)

    cursor.execute(sql,data)

    if cursor.rowcount == 0 :
        return jsonify({"message":"Invalid credentials"})
    else:
        user = cursor.fetchone()
        return jsonify({"message":"Login successful", "user":user})
    
@app.route("/api/add_product", methods=["POST"])
def add_product():
    product_name= request.form ["product_name"]
    product_description= request.form ["product_description"]
    product_cartegory= request.form ["product_cartegory"]
    product_cost = request.form ["product_cost"]
    product_image = request.files ["product_image"]

    print(product_name,product_description,product_cartegory,product_cost,product_image)

    # get image file name
    image_name = product_image.filename

    # save image into the images folder

    file_path = os.path.join(app.config["UPLOAD_FOLDER"], image_name)
    product_image.save(file_path)



    connection= pymysql.connect(host="localhost", user="root", password="",database="quincy_sokogarden")
    cursor=connection.cursor()
    sql = "insert into product_details(product_name,product_description,product_category,product_cost,product_image) values(%s,%s,%s,%s,%s)"
    data = (product_name,product_description,product_cartegory,product_cost,image_name)

    cursor.execute(sql,data)
    connection.commit()



    return jsonify({"message": "product added succesfully"})




if __name__ == "__main__":
    app.run(debug=True) 
